name: PR Tests

on:
  pull_request_target:
    branches:
      - main
      - develop
      - dev

permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest
    outputs:
      lint_result: ${{ steps.lint.outcome }}
      test_result: ${{ steps.test.outcome }}
      e2e_result: ${{ steps.e2e.outcome }}

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Run linter
        id: lint
        run: npm run lint
        continue-on-error: false

      - name: Run unit tests
        id: test
        run: npm run test:run
        env:
          CI: true

      - name: Run tests with coverage
        id: coverage
        run: npm run test:coverage
        continue-on-error: true

      - name: Install system dependencies for Playwright
        if: false
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb libgtk-3-0 libnotify4 libnss3 libxss1 libasound2
        continue-on-error: true

      - name: Install Playwright browsers
        if: false
        run: npx playwright install --with-deps
        continue-on-error: true

      - name: Build application for e2e tests
        if: false
        run: npm run build
        continue-on-error: true

      - name: Run e2e tests
        id: e2e
        if: false
        run: xvfb-run --auto-servernum npm run test:e2e
        env:
          CI: true
        continue-on-error: true

      - name: Upload e2e test results
        if: always() && steps.e2e.outcome != 'skipped'
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7
        continue-on-error: true

      - name: Comment PR with test results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const lintStatus = '${{ steps.lint.outcome }}';
            const testStatus = '${{ steps.test.outcome }}';
            const coverageStatus = '${{ steps.coverage.outcome }}';
            const e2eStatus = '${{ steps.e2e.outcome }}';

            const requiredPassed = lintStatus === 'success' && testStatus === 'success';
            const allPassed = requiredPassed && (e2eStatus === 'success' || e2eStatus === 'skipped');
            const emoji = requiredPassed ? '✅' : '❌';

            const statusEmoji = (status) => {
              if (status === 'success') return '✅';
              if (status === 'failure') return '❌';
              if (status === 'skipped') return '⏭️';
              return '⚠️';
            };

            const comment = `## ${emoji} Test Results

            **Overall Status**: ${requiredPassed ? 'Required tests passed!' : 'Tests failed'}

            - **Linting**: ${statusEmoji(lintStatus)} ${lintStatus}
            - **Unit Tests**: ${statusEmoji(testStatus)} ${testStatus}
            - **Coverage**: ${statusEmoji(coverageStatus)} ${coverageStatus}
            - **E2E Tests**: ${statusEmoji(e2eStatus)} ${e2eStatus}${e2eStatus === 'failure' ? ' (not blocking)' : ''}

            ${requiredPassed ? '✨ Great work! All required checks passed.' : '⚠️ Please fix the failing tests before merging.'}
            ${e2eStatus === 'failure' ? '\n⚠️ Note: E2E tests failed but are not blocking the PR.' : ''}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Require all tests to pass
  all-tests-passed:
    runs-on: ubuntu-latest
    needs: test
    if: always()
    steps:
      - name: Check test results
        run: |
          LINT_RESULT="${{ needs.test.outputs.lint_result }}"
          TEST_RESULT="${{ needs.test.outputs.test_result }}"

          echo "Lint result: $LINT_RESULT"
          echo "Test result: $TEST_RESULT"

          if [ "$LINT_RESULT" != "success" ] || [ "$TEST_RESULT" != "success" ]; then
            echo "❌ Tests failed! Cannot merge this PR."
            echo "Linting: $LINT_RESULT"
            echo "Unit Tests: $TEST_RESULT"
            exit 1
          fi
          echo "✅ All tests passed!"
