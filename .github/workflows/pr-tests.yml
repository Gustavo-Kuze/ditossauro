name: PR Tests

on:
  pull_request:
    branches:
      - main
      - develop
      - dev
  pull_request_target:
    branches:
      - main
      - develop
      - dev

permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest
    outputs:
      lint_result: ${{ steps.lint.outcome }}
      test_result: ${{ steps.test.outcome }}

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Run linter
        id: lint
        run: npm run lint
        continue-on-error: false

      - name: Run unit tests
        id: test
        run: npm run test:run
        env:
          CI: true

      - name: Run tests with coverage
        id: coverage
        run: npm run test:coverage
        continue-on-error: true

      - name: Comment PR with test results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const lintStatus = '${{ steps.lint.outcome }}';
            const testStatus = '${{ steps.test.outcome }}';
            const coverageStatus = '${{ steps.coverage.outcome }}';

            const allPassed = lintStatus === 'success' && testStatus === 'success';
            const emoji = allPassed ? '✅' : '❌';

            const statusEmoji = (status) => {
              if (status === 'success') return '✅';
              if (status === 'failure') return '❌';
              if (status === 'skipped') return '⏭️';
              return '⚠️';
            };

            const comment = `## ${emoji} Test Results

            **Overall Status**: ${allPassed ? 'All tests passed!' : 'Tests failed'}

            - **Linting**: ${statusEmoji(lintStatus)} ${lintStatus}
            - **Unit Tests**: ${statusEmoji(testStatus)} ${testStatus}
            - **Coverage**: ${statusEmoji(coverageStatus)} ${coverageStatus}

            ${allPassed ? '✨ Great work! All checks passed.' : '⚠️ Please fix the failing tests before merging.'}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Require all tests to pass
  all-tests-passed:
    runs-on: ubuntu-latest
    needs: test
    if: always()
    steps:
      - name: Check test results
        run: |
          LINT_RESULT="${{ needs.test.outputs.lint_result }}"
          TEST_RESULT="${{ needs.test.outputs.test_result }}"

          echo "Lint result: $LINT_RESULT"
          echo "Test result: $TEST_RESULT"

          if [ "$LINT_RESULT" != "success" ] || [ "$TEST_RESULT" != "success" ]; then
            echo "❌ Tests failed! Cannot merge this PR."
            echo "Linting: $LINT_RESULT"
            echo "Unit Tests: $TEST_RESULT"
            exit 1
          fi
          echo "✅ All tests passed!"
