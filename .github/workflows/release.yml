name: Build and Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  release:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [windows-latest] # [macos-latest, ubuntu-latest, windows-latest]

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Python (for native modules)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup MSBuild (Windows only)
        if: matrix.os == 'windows-latest'
        uses: microsoft/setup-msbuild@v2

      - name: Add MSBuild to PATH (Windows only)
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          # GitHub Actions runners already have Visual Studio Build Tools
          # We just need to ensure they're in the PATH
          $vsPath = & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -latest -property installationPath
          Write-Host "Visual Studio path: $vsPath"
          Add-Content $env:GITHUB_PATH "$vsPath\MSBuild\Current\Bin"
          Add-Content $env:GITHUB_PATH "$vsPath\Common7\IDE\CommonExtensions\Microsoft\CMake\CMake\bin"

      - name: Install dependencies
        run: npm ci
        env:
          npm_config_build_from_source: true
          npm_config_msvs_version: 2022

      - name: Rebuild native modules (Windows)
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          Write-Host "Node version: $(node --version)"
          Write-Host "npm version: $(npm --version)"
          Write-Host "Python version: $(python --version)"

          # Run postinstall to rebuild uiohook-napi
          npm run postinstall

          # Explicitly rebuild robotjs for Electron
          npx electron-rebuild -f -w robotjs -v
        env:
          npm_config_build_from_source: true
          npm_config_msvs_version: 2022
          DEBUG: electron-rebuild

      - name: Get version from package.json
        id: package_version
        shell: bash
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      # - name: Build/release Electron app (macOS)
      #   if: matrix.os == 'macos-latest'
      #   run: npm run make
      #   env:
      #     NODE_ENV: production

      # - name: Build/release Electron app (Linux)
      #   if: matrix.os == 'ubuntu-latest'
      #   run: npm run make
      #   env:
      #     NODE_ENV: production

      - name: Build/release Electron app (Windows)
        if: matrix.os == 'windows-latest'
        run: npm run make
        env:
          NODE_ENV: production

      - name: Upload artifacts (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: |
            out/make/squirrel.windows/**/*.exe
            out/make/squirrel.windows/**/*.nupkg
            out/make/zip/win32/**/*.zip

      # - name: Upload artifacts (macOS)
      #   if: matrix.os == 'macos-latest'
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: macos-artifacts
      #     path: |
      #       out/make/**/*.zip
      #       out/make/**/*.dmg

      # - name: Upload artifacts (Linux)
      #   if: matrix.os == 'ubuntu-latest'
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: linux-artifacts
      #     path: |
      #       out/make/**/*.deb
      #       out/make/**/*.rpm

  create-release:
    needs: release
    runs-on: ubuntu-latest

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4

      - name: Get version from package.json
        id: package_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.package_version.outputs.version }}
          name: Release v${{ steps.package_version.outputs.version }}
          body: |
            ## Ditossauro v${{ steps.package_version.outputs.version }}

            ### What's New
            - Full app rebranding of OpenWispr to Ditossauro
            - Renamed the "bro" command to "dito" for personal assistant interactions

            ### Downloads
            - **Windows**: Download the `.exe` installer or `.nupkg` package
            - **macOS**: -
            - **Linux**: -

            ### Installation
            1. Download the appropriate file for your operating system
            2. Run the installer
            3. Configure your Groq API key in settings
            4. Set up your hotkeys and start transcribing!

            For more information, see the [README](https://github.com/${{ github.repository }}/blob/main/README.md).
          draft: false
          prerelease: false
          files: |
            artifacts/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
